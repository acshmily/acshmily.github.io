<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="kubernetes安装手记stage1"><meta name="keywords" content="nginx,springboot,kubernetes"><meta name="author" content="acshmily"><meta name="copyright" content="acshmily"><title>kubernetes安装手记stage1 | acshmily的碎碎念</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '5.4.0'
} </script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="acshmily的碎碎念" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2bind9"><span class="toc-number">1.</span> <span class="toc-text">部署bind9</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Docker%E7%8E%AF%E5%A2%83"><span class="toc-number">2.</span> <span class="toc-text">安装Docker环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2harbor"><span class="toc-number">3.</span> <span class="toc-text">部署harbor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%AF%81%E4%B9%A6%E7%8E%AF%E5%A2%83"><span class="toc-number">4.</span> <span class="toc-text">配置证书环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEetcd%E9%9B%86%E7%BE%A4"><span class="toc-number">5.</span> <span class="toc-text">配置etcd集群</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">acshmily</div><div class="author-info__description text-center">坚持每天进步一点点</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">17</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">26</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">4</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">acshmily的碎碎念</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right"></span></div><div id="post-info"><div id="post-title">kubernetes安装手记stage1</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-04-05</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/kubernetes%E7%AC%94%E8%AE%B0/">kubernetes笔记</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>#kubernetes安装手记stage1    </p>
<p>​    由于只是研究学习用，刚好公司有资源可以申请，趁着有兴趣进行了搭建一下。</p>
<p>​    本次用到的硬件服务器约为9台，分别为：</p>
<table>
<thead>
<tr>
<th>ip</th>
<th>配置</th>
<th>角色</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.82.21</td>
<td>12U 64G 500G</td>
<td>master、node节点</td>
</tr>
<tr>
<td>192.168.82.22</td>
<td>12U 64G 500G</td>
<td>master、node节点</td>
</tr>
<tr>
<td>192.168.82.23</td>
<td>12U 64G 500G</td>
<td>master、node节点</td>
</tr>
<tr>
<td>192.168.82.24</td>
<td>12U 64G 500G</td>
<td>node节点</td>
</tr>
<tr>
<td>192.168.82.25</td>
<td>12U 64G 500G</td>
<td>node节点</td>
</tr>
<tr>
<td>192.168.82.26</td>
<td>4U 8G 500G</td>
<td>harbor、yaml 配置节点</td>
</tr>
<tr>
<td>192.168.82.27</td>
<td>8U 16G 500G</td>
<td>etcd 节点</td>
</tr>
<tr>
<td>192.168.82.28</td>
<td>8U 16G 500G</td>
<td>etcd 节点</td>
</tr>
<tr>
<td>192.168.82.29</td>
<td>8U 16G 500G</td>
<td>etcd 节点</td>
</tr>
<tr>
<td>192.168.82.30</td>
<td>4U 8G 500G</td>
<td>keepalived节点、bind9</td>
</tr>
<tr>
<td>192.168.82.31</td>
<td>4U 8G 500G</td>
<td>keepalived节点</td>
</tr>
</tbody></table>
<h2 id="部署bind9"><a href="#部署bind9" class="headerlink" title="部署bind9"></a>部署bind9</h2><p><code>yum install bind9</code></p>
<p>配置相关信息，主机域</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/var/named/host.com.zone &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="variable">$ORIGIN</span> host.com.</span><br><span class="line"><span class="variable">$TTL</span> 600    ; 10 minutes</span><br><span class="line">@       IN SOA  dns.host.com. dnsadmin.host.com. (</span><br><span class="line">                2021033001 ; serial</span><br><span class="line">                10800      ; refresh (3 hours)</span><br><span class="line">                900        ; retry (15 minutes)</span><br><span class="line">                604800     ; expire (1 week)</span><br><span class="line">                86400      ; minimum (1 day)</span><br><span class="line">                )</span><br><span class="line">            NS   dns.host.com.</span><br><span class="line"><span class="variable">$TTL</span> 60 ; 1 minute</span><br><span class="line">dns                A    192.168.83.30</span><br><span class="line">HDSS7-21           A    192.168.82.21</span><br><span class="line">HDSS7-22           A    192.168.82.22</span><br><span class="line">HDSS7-23           A    192.168.82.23</span><br><span class="line">HDSS7-24           A    192.168.82.24</span><br><span class="line">HDSS7-25           A    192.168.82.25</span><br><span class="line">HDSS7-26           A    192.168.82.26</span><br><span class="line">HDSS7-27           A    192.168.82.27</span><br><span class="line">HDSS7-28           A    192.168.82.28</span><br><span class="line">HDSS7-29           A    192.168.82.29</span><br><span class="line">HDSS7-30           A    192.168.82.30</span><br><span class="line">HDSS7-31           A    192.168.82.31</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>配置业务域</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/var/named/bst.com.zone &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="variable">$ORIGIN</span> bst.com.</span><br><span class="line"><span class="variable">$TTL</span> 600    ; 10 minutes</span><br><span class="line">@       IN SOA  dns.bst.com. dnsadmin.bst.com. (</span><br><span class="line">                2021033001 ; serial</span><br><span class="line">                10800      ; refresh (3 hours)</span><br><span class="line">                900        ; retry (15 minutes)</span><br><span class="line">                604800     ; expire (1 week)</span><br><span class="line">                86400      ; minimum (1 day)</span><br><span class="line">                )</span><br><span class="line">            NS   dns.zq.com.</span><br><span class="line"><span class="variable">$TTL</span> 60 ; 1 minute</span><br><span class="line">dns                A    192.168.82.30</span><br><span class="line">harbor             A    192.168.82.26</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>所有节点都需要修改DNS配置为 192.168.82.30</p>
<h2 id="安装Docker环境"><a href="#安装Docker环境" class="headerlink" title="安装Docker环境"></a>安装Docker环境</h2><p><code>curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</code></p>
<p>每一台k8s节点都需要分别配置deamon.json，以182.21为例，bip为 172.7.21.1/24；同理 182.22 宿主机，则bip为 172.7.22.1/24</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/docker/</span><br><span class="line"></span><br><span class="line">cat &gt;/etc/docker/daemon.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;graph&quot;: &quot;/data/docker&quot;,</span></span><br><span class="line"><span class="string">    &quot;storage-driver&quot;: &quot;overlay2&quot;,</span></span><br><span class="line"><span class="string">    &quot;insecure-registries&quot;: [&quot;harbor.bst.com&quot;],</span></span><br><span class="line"><span class="string">    &quot;bip&quot;: &quot;172.7.21.1/24&quot;,</span></span><br><span class="line"><span class="string">    &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span></span><br><span class="line"><span class="string">    &quot;live-restore&quot;: true</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h2 id="部署harbor"><a href="#部署harbor" class="headerlink" title="部署harbor"></a>部署harbor</h2><p>安装docker-compose</p>
<p><code>yum install epel-release -y --nogpgcheck</code></p>
<p>离线安装harbor方式，下载地址可参考<a target="_blank" rel="noopener" href="https://github.com/goharbor/harbor/releases">https://github.com/goharbor/harbor/releases</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar xf harbor-offline-installer-v2.2.1.tgz -C /opt/</span><br><span class="line"><span class="built_in">cd</span> /opt/</span><br><span class="line">mv harbor/ harbor-v2.2.1</span><br><span class="line">ln -s /opt/harbor-v2.2.1/ /opt/harbor</span><br></pre></td></tr></table></figure>

<p>修改部分配置文件,/opt/harbor/harbor.yml，以下仅为修改项目</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hostname:</span> <span class="string">harbor.zq.com</span></span><br><span class="line"><span class="attr">http:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">180</span> </span><br><span class="line">  <span class="string">harbor_admin_password:Harbor12345</span></span><br><span class="line"><span class="attr">data_volume:</span> <span class="string">/data/harbor</span></span><br><span class="line"><span class="attr">log:</span></span><br><span class="line">  <span class="attr">level:</span> <span class="string">info</span></span><br><span class="line"><span class="attr">rotate_count:</span> <span class="number">50</span></span><br><span class="line"><span class="attr">rotate_size:</span> <span class="string">200M</span></span><br><span class="line"><span class="attr">location:</span> <span class="string">/data/harbor/logs</span></span><br></pre></td></tr></table></figure>

<p>创建必要的存储地址</p>
<p><code>mkdir -p /data/harbor/logs</code></p>
<p>安装运行harbor</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/harbor/</span><br><span class="line">yum install docker-compose -y</span><br><span class="line">sh /opt/harbor/install.sh</span><br><span class="line">docker-compose ps</span><br><span class="line">docker ps -a</span><br></pre></td></tr></table></figure>

<p>安装NGINX反代harbor服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">yum install nginx -y</span><br><span class="line">vim /etc/nginx/conf.d/harbor.zq.com.conf</span><br><span class="line"><span class="comment">## 添加配置yu</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name harbor.zq.com;</span><br><span class="line"></span><br><span class="line">    client_max_body_size 1000m;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">    proxy_pass http://127.0.0.1:180;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置证书环境"><a href="#配置证书环境" class="headerlink" title="配置证书环境"></a>配置证书环境</h2><p>yaml服务器，下载安装cfssl、cfssljson</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/bin/cfssl</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/bin/cfssl-json</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/bin/cfssl-certinfo</span><br><span class="line">chmod +x /usr/bin/cfssl*</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>统一证书路径放在/opt/certs下，创建CA根证书、etcd服务端证书</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/opt/certs/ca-csr.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;CN&quot;: &quot;Besttone&quot;,</span></span><br><span class="line"><span class="string">    &quot;hosts&quot;: [],</span></span><br><span class="line"><span class="string">    &quot;key&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class="line"><span class="string">        &quot;size&quot;: 2048</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;names&quot;: [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">        &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class="line"><span class="string">        &quot;ST&quot;: &quot;shanghai&quot;,</span></span><br><span class="line"><span class="string">        &quot;L&quot;: &quot;shanghai&quot;,</span></span><br><span class="line"><span class="string">        &quot;O&quot;: &quot;lianjie&quot;,</span></span><br><span class="line"><span class="string">        &quot;OU&quot;: &quot;ops&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    ],</span></span><br><span class="line"><span class="string">    &quot;ca&quot;: &#123;</span></span><br><span class="line"><span class="string">    	&quot;expiry&quot;: &quot;175200h&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssl-json -bare ca</span><br><span class="line">cat &gt;/opt/certs/ca-config.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;signing&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;default&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;expiry&quot;: &quot;175200h&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;profiles&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;server&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;expiry&quot;: &quot;175200h&quot;,</span></span><br><span class="line"><span class="string">            &quot;usages&quot;: [</span></span><br><span class="line"><span class="string">            &quot;signing&quot;,</span></span><br><span class="line"><span class="string">            &quot;key encipherment&quot;,</span></span><br><span class="line"><span class="string">            &quot;server auth&quot;</span></span><br><span class="line"><span class="string">            ]</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;client&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;expiry&quot;: &quot;175200h&quot;,</span></span><br><span class="line"><span class="string">            &quot;usages&quot;: [</span></span><br><span class="line"><span class="string">            &quot;signing&quot;,</span></span><br><span class="line"><span class="string">            &quot;key encipherment&quot;,</span></span><br><span class="line"><span class="string">            &quot;client auth&quot;</span></span><br><span class="line"><span class="string">            ]</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;peer&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;expiry&quot;: &quot;175200h&quot;,</span></span><br><span class="line"><span class="string">            &quot;usages&quot;: [</span></span><br><span class="line"><span class="string">            &quot;signing&quot;,</span></span><br><span class="line"><span class="string">            &quot;key encipherment&quot;,</span></span><br><span class="line"><span class="string">            &quot;server auth&quot;,</span></span><br><span class="line"><span class="string">            &quot;client auth&quot;</span></span><br><span class="line"><span class="string">            ]</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">cat &gt;/opt/certs/etcd-peer-csr.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;CN&quot;: &quot;k8s-etcd&quot;,</span></span><br><span class="line"><span class="string">    &quot;hosts&quot;: [</span></span><br><span class="line"><span class="string">        &quot;192.168.82.27&quot;,</span></span><br><span class="line"><span class="string">        &quot;192.168.82.28&quot;,</span></span><br><span class="line"><span class="string">        &quot;192.168.82.29&quot;,</span></span><br><span class="line"><span class="string">        &quot;192.168.82.30&quot;,</span></span><br><span class="line"><span class="string">        &quot;192.168.82.31&quot;</span></span><br><span class="line"><span class="string">    ],</span></span><br><span class="line"><span class="string">    &quot;key&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class="line"><span class="string">        &quot;size&quot;: 2048</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;names&quot;: [</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class="line"><span class="string">        &quot;ST&quot;: &quot;shanghai&quot;,</span></span><br><span class="line"><span class="string">        &quot;L&quot;: &quot;shanghai&quot;,</span></span><br><span class="line"><span class="string">        &quot;O&quot;: &quot;lianjie&quot;,</span></span><br><span class="line"><span class="string">        &quot;OU&quot;: &quot;ops&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer etcd-peer-csr.json |cfssl-json -bare etcd-peer</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="配置etcd集群"><a href="#配置etcd集群" class="headerlink" title="配置etcd集群"></a>配置etcd集群</h2><p>下载etcd执行文件解压到/opt/etcd下，并下载证书</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">useradd -s /sbin/nologin -M etcd</span><br><span class="line">mkdir -p /opt/etcd/certs /data/etcd /data/logs/etcd-server</span><br><span class="line"><span class="built_in">cd</span> /opt/etcd/certs/</span><br><span class="line">wget http://yaml.bst.com/certs/ca.pem</span><br><span class="line">wget http://yaml.bst.com/certs/etcd-peer-key.pem</span><br><span class="line">wget http://yaml.bst.com/certs/etcd-peer.pem</span><br><span class="line">chmod 600 etcd-peer-key.pem</span><br><span class="line">chown -R etcd.etcd /opt/etcd</span><br><span class="line">chown -R etcd.etcd /opt/etcd-v3.2.32/</span><br><span class="line">chown -R etcd.etcd /data/logs/etcd-server/</span><br><span class="line">chown -R etcd.etcd /data/etcd</span><br></pre></td></tr></table></figure>

<p>配置sh文件，每一台etcd节点配置文件稍有有不同，关注name、listen-peer-urls、initial-advertise-peer-urls</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/opt/etcd/etcd-server-startup.sh &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">./etcd \</span><br><span class="line">--name etcd-server-82-29 \</span><br><span class="line">--data-dir /data/etcd/etcd-server \</span><br><span class="line">--listen-peer-urls https://192.168.82.29:2380 \</span><br><span class="line">--listen-client-urls https://192.168.82.29:2379,http://127.0.0.1:2379 \</span><br><span class="line">--quota-backend-bytes 8000000000 \</span><br><span class="line">--initial-advertise-peer-urls https://192.168.82.29:2380 \</span><br><span class="line">--advertise-client-urls https://192.168.82.29:2379,http://127.0.0.1:2379 \</span><br><span class="line">--initial-cluster etcd-server-82-27=https://192.168.82.27:2380,etcd-server-82-28=https://192.168.82.28:2380,etcd-server-82-29=https://192.168.82.29:2380 \</span><br><span class="line">--ca-file ./certs/ca.pem \</span><br><span class="line">--cert-file ./certs/etcd-peer.pem \</span><br><span class="line">--key-file ./certs/etcd-peer-key.pem \</span><br><span class="line">--client-cert-auth \</span><br><span class="line">--trusted-ca-file ./certs/ca.pem \</span><br><span class="line">--peer-ca-file ./certs/ca.pem \</span><br><span class="line">--peer-cert-file ./certs/etcd-peer.pem \</span><br><span class="line">--peer-key-file ./certs/etcd-peer-key.pem \</span><br><span class="line">--peer-client-cert-auth \</span><br><span class="line">--peer-trusted-ca-file ./certs/ca.pem \</span><br><span class="line">--log-output stdout</span><br><span class="line">EOF</span><br><span class="line">chmod +x /opt/etcd/etcd-server-startup.sh</span><br></pre></td></tr></table></figure>

<p>配置supervisor管理文件，并启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/etc/supervisord.d/etcd-server.ini &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[program:etcd-server] ; 显示的程序名,类型my.cnf,可以有多个</span></span><br><span class="line"><span class="string">command=sh /opt/etcd/etcd-server-startup.sh</span></span><br><span class="line"><span class="string">numprocs=1 ; 启动进程数 (def 1)</span></span><br><span class="line"><span class="string">directory=/opt/etcd ; 启动命令前切换的目录 (def no cwd)</span></span><br><span class="line"><span class="string">autostart=true ; 是否自启 (default: true)</span></span><br><span class="line"><span class="string">autorestart=true ; 是否自动重启 (default: true)</span></span><br><span class="line"><span class="string">startsecs=30 ; 服务运行多久判断为成功(def. 1)</span></span><br><span class="line"><span class="string">startretries=3 ; 启动重试次数 (default 3)</span></span><br><span class="line"><span class="string">exitcodes=0,2 ; 退出状态码 (default 0,2)</span></span><br><span class="line"><span class="string">stopsignal=QUIT ; 退出信号 (default TERM)</span></span><br><span class="line"><span class="string">stopwaitsecs=10 ; 退出延迟时间 (default 10)</span></span><br><span class="line"><span class="string">user=etcd ; 运行用户</span></span><br><span class="line"><span class="string">redirect_stderr=true ; 是否重定向错误输出到标准输出(def false)</span></span><br><span class="line"><span class="string">stdout_logfile=/data/logs/etcd-server/etcd.stdout.log</span></span><br><span class="line"><span class="string">stdout_logfile_maxbytes=64MB ; 日志文件大小 (default 50MB)</span></span><br><span class="line"><span class="string">stdout_logfile_backups=4 ; 日志文件滚动个数 (default 10)</span></span><br><span class="line"><span class="string">stdout_capture_maxbytes=1MB ; 设定capture管道的大小(default 0)</span></span><br><span class="line"><span class="string">;子进程还有子进程,需要添加这个参数,避免产生孤儿进程</span></span><br><span class="line"><span class="string">killasgroup=true</span></span><br><span class="line"><span class="string">stopasgroup=true</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment">## 启动服务，检查etcd集群是否正常</span></span><br><span class="line">supervisorctl update</span><br><span class="line">supervisorctl status</span><br><span class="line">netstat -lntup|grep etcd</span><br><span class="line">/opt/etcd/etcdctl cluster-health</span><br><span class="line">/opt/etcd/etcdctl member list</span><br></pre></td></tr></table></figure>



</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">acshmily</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2021/04/05/kubernetes安装手记stage1/">http://yoursite.com/2021/04/05/kubernetes安装手记stage1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com">acshmily的碎碎念</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/nginx/">nginx</a><a class="post-meta__tags" href="/tags/springboot/">springboot</a><a class="post-meta__tags" href="/tags/kubernetes/">kubernetes</a></div><nav id="pagination"><div class="next-post pull-right"><a href="/2020/11/30/docker%E8%BF%90%E8%A1%8Cnginx%E9%85%8D%E7%BD%AE%E8%AF%81%E4%B9%A6/"><span>docker运行nginx配置证书</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2021 By acshmily</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>
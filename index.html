<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="坚持每天进步一点点"><meta name="keywords" content=""><meta name="author" content="acshmily"><meta name="copyright" content="acshmily"><title>acshmily的碎碎念</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '5.4.0'
} </script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="acshmily的碎碎念" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">acshmily</div><div class="author-info__description text-center">坚持每天进步一点点</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">17</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">26</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">4</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">acshmily的碎碎念</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right"></span></div><div id="site-info"><div id="site-title">acshmily的碎碎念</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2021/04/05/kubernetes%E5%AE%89%E8%A3%85%E6%89%8B%E8%AE%B0stage1/">kubernetes安装手记stage1</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-04-05</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/kubernetes%E7%AC%94%E8%AE%B0/">kubernetes笔记</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/nginx/">nginx</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/springboot/">springboot</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/kubernetes/">kubernetes</a></span><div class="content"><p>#kubernetes安装手记stage1    </p>
<p>​    由于只是研究学习用，刚好公司有资源可以申请，趁着有兴趣进行了搭建一下。</p>
<p>​    本次用到的硬件服务器约为9台，分别为：</p>
<table>
<thead>
<tr>
<th>ip</th>
<th>配置</th>
<th>角色</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.82.21</td>
<td>12U 64G 500G</td>
<td>master、node节点</td>
</tr>
<tr>
<td>192.168.82.22</td>
<td>12U 64G 500G</td>
<td>master、node节点</td>
</tr>
<tr>
<td>192.168.82.23</td>
<td>12U 64G 500G</td>
<td>master、node节点</td>
</tr>
<tr>
<td>192.168.82.24</td>
<td>12U 64G 500G</td>
<td>node节点</td>
</tr>
<tr>
<td>192.168.82.25</td>
<td>12U 64G 500G</td>
<td>node节点</td>
</tr>
<tr>
<td>192.168.82.26</td>
<td>4U 8G 500G</td>
<td>harbor、yaml 配置节点</td>
</tr>
<tr>
<td>192.168.82.27</td>
<td>8U 16G 500G</td>
<td>etcd 节点</td>
</tr>
<tr>
<td>192.168.82.28</td>
<td>8U 16G 500G</td>
<td>etcd 节点</td>
</tr>
<tr>
<td>192.168.82.29</td>
<td>8U 16G 500G</td>
<td>etcd 节点</td>
</tr>
<tr>
<td>192.168.82.30</td>
<td>4U 8G 500G</td>
<td>keepalived节点、bind9</td>
</tr>
<tr>
<td>192.168.82.31</td>
<td>4U 8G 500G</td>
<td>keepalived节点</td>
</tr>
</tbody></table>
<h2 id="部署bind9"><a href="#部署bind9" class="headerlink" title="部署bind9"></a>部署bind9</h2><p><code>yum install bind9</code></p>
<p>配置相关信息，主机域</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/var/named/host.com.zone &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="variable">$ORIGIN</span> host.com.</span><br><span class="line"><span class="variable">$TTL</span> 600    ; 10 minutes</span><br><span class="line">@       IN SOA  dns.host.com. dnsadmin.host.com. (</span><br><span class="line">                2021033001 ; serial</span><br><span class="line">                10800      ; refresh (3 hours)</span><br><span class="line">                900        ; retry (15 minutes)</span><br><span class="line">                604800     ; expire (1 week)</span><br><span class="line">                86400      ; minimum (1 day)</span><br><span class="line">                )</span><br><span class="line">            NS   dns.host.com.</span><br><span class="line"><span class="variable">$TTL</span> 60 ; 1 minute</span><br><span class="line">dns                A    192.168.83.30</span><br><span class="line">HDSS7-21           A    192.168.82.21</span><br><span class="line">HDSS7-22           A    192.168.82.22</span><br><span class="line">HDSS7-23           A    192.168.82.23</span><br><span class="line">HDSS7-24           A    192.168.82.24</span><br><span class="line">HDSS7-25           A    192.168.82.25</span><br><span class="line">HDSS7-26           A    192.168.82.26</span><br><span class="line">HDSS7-27           A    192.168.82.27</span><br><span class="line">HDSS7-28           A    192.168.82.28</span><br><span class="line">HDSS7-29           A    192.168.82.29</span><br><span class="line">HDSS7-30           A    192.168.82.30</span><br><span class="line">HDSS7-31           A    192.168.82.31</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>配置业务域</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/var/named/bst.com.zone &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="variable">$ORIGIN</span> bst.com.</span><br><span class="line"><span class="variable">$TTL</span> 600    ; 10 minutes</span><br><span class="line">@       IN SOA  dns.bst.com. dnsadmin.bst.com. (</span><br><span class="line">                2021033001 ; serial</span><br><span class="line">                10800      ; refresh (3 hours)</span><br><span class="line">                900        ; retry (15 minutes)</span><br><span class="line">                604800     ; expire (1 week)</span><br><span class="line">                86400      ; minimum (1 day)</span><br><span class="line">                )</span><br><span class="line">            NS   dns.zq.com.</span><br><span class="line"><span class="variable">$TTL</span> 60 ; 1 minute</span><br><span class="line">dns                A    192.168.82.30</span><br><span class="line">harbor             A    192.168.82.26</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>所有节点都需要修改DNS配置为 192.168.82.30</p>
<h2 id="安装Docker环境"><a href="#安装Docker环境" class="headerlink" title="安装Docker环境"></a>安装Docker环境</h2><p><code>curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</code></p>
<p>每一台k8s节点都需要分别配置deamon.json，以182.21为例，bip为 172.7.21.1/24；同理 182.22 宿主机，则bip为 172.7.22.1/24</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/docker/</span><br><span class="line"></span><br><span class="line">cat &gt;/etc/docker/daemon.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;graph&quot;: &quot;/data/docker&quot;,</span></span><br><span class="line"><span class="string">    &quot;storage-driver&quot;: &quot;overlay2&quot;,</span></span><br><span class="line"><span class="string">    &quot;insecure-registries&quot;: [&quot;harbor.bst.com&quot;],</span></span><br><span class="line"><span class="string">    &quot;bip&quot;: &quot;172.7.21.1/24&quot;,</span></span><br><span class="line"><span class="string">    &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span></span><br><span class="line"><span class="string">    &quot;live-restore&quot;: true</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h2 id="部署harbor"><a href="#部署harbor" class="headerlink" title="部署harbor"></a>部署harbor</h2><p>安装docker-compose</p>
<p><code>yum install epel-release -y --nogpgcheck</code></p>
<p>离线安装harbor方式，下载地址可参考<a target="_blank" rel="noopener" href="https://github.com/goharbor/harbor/releases">https://github.com/goharbor/harbor/releases</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar xf harbor-offline-installer-v2.2.1.tgz -C /opt/</span><br><span class="line"><span class="built_in">cd</span> /opt/</span><br><span class="line">mv harbor/ harbor-v2.2.1</span><br><span class="line">ln -s /opt/harbor-v2.2.1/ /opt/harbor</span><br></pre></td></tr></table></figure>

<p>修改部分配置文件,/opt/harbor/harbor.yml，以下仅为修改项目</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hostname:</span> <span class="string">harbor.zq.com</span></span><br><span class="line"><span class="attr">http:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">180</span> </span><br><span class="line">  <span class="string">harbor_admin_password:Harbor12345</span></span><br><span class="line"><span class="attr">data_volume:</span> <span class="string">/data/harbor</span></span><br><span class="line"><span class="attr">log:</span></span><br><span class="line">  <span class="attr">level:</span> <span class="string">info</span></span><br><span class="line"><span class="attr">rotate_count:</span> <span class="number">50</span></span><br><span class="line"><span class="attr">rotate_size:</span> <span class="string">200M</span></span><br><span class="line"><span class="attr">location:</span> <span class="string">/data/harbor/logs</span></span><br></pre></td></tr></table></figure>

<p>创建必要的存储地址</p>
<p><code>mkdir -p /data/harbor/logs</code></p>
<p>安装运行harbor</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/harbor/</span><br><span class="line">yum install docker-compose -y</span><br><span class="line">sh /opt/harbor/install.sh</span><br><span class="line">docker-compose ps</span><br><span class="line">docker ps -a</span><br></pre></td></tr></table></figure>

<p>安装NGINX反代harbor服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">yum install nginx -y</span><br><span class="line">vim /etc/nginx/conf.d/harbor.zq.com.conf</span><br><span class="line"><span class="comment">## 添加配置yu</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name harbor.zq.com;</span><br><span class="line"></span><br><span class="line">    client_max_body_size 1000m;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">    proxy_pass http://127.0.0.1:180;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置证书环境"><a href="#配置证书环境" class="headerlink" title="配置证书环境"></a>配置证书环境</h2><p>yaml服务器，下载安装cfssl、cfssljson</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/bin/cfssl</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/bin/cfssl-json</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/bin/cfssl-certinfo</span><br><span class="line">chmod +x /usr/bin/cfssl*</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>统一证书路径放在/opt/certs下，创建CA根证书、etcd服务端证书</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/opt/certs/ca-csr.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;CN&quot;: &quot;Besttone&quot;,</span></span><br><span class="line"><span class="string">    &quot;hosts&quot;: [],</span></span><br><span class="line"><span class="string">    &quot;key&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class="line"><span class="string">        &quot;size&quot;: 2048</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;names&quot;: [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">        &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class="line"><span class="string">        &quot;ST&quot;: &quot;shanghai&quot;,</span></span><br><span class="line"><span class="string">        &quot;L&quot;: &quot;shanghai&quot;,</span></span><br><span class="line"><span class="string">        &quot;O&quot;: &quot;lianjie&quot;,</span></span><br><span class="line"><span class="string">        &quot;OU&quot;: &quot;ops&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    ],</span></span><br><span class="line"><span class="string">    &quot;ca&quot;: &#123;</span></span><br><span class="line"><span class="string">    	&quot;expiry&quot;: &quot;175200h&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssl-json -bare ca</span><br><span class="line">cat &gt;/opt/certs/ca-config.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;signing&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;default&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;expiry&quot;: &quot;175200h&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;profiles&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;server&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;expiry&quot;: &quot;175200h&quot;,</span></span><br><span class="line"><span class="string">            &quot;usages&quot;: [</span></span><br><span class="line"><span class="string">            &quot;signing&quot;,</span></span><br><span class="line"><span class="string">            &quot;key encipherment&quot;,</span></span><br><span class="line"><span class="string">            &quot;server auth&quot;</span></span><br><span class="line"><span class="string">            ]</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;client&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;expiry&quot;: &quot;175200h&quot;,</span></span><br><span class="line"><span class="string">            &quot;usages&quot;: [</span></span><br><span class="line"><span class="string">            &quot;signing&quot;,</span></span><br><span class="line"><span class="string">            &quot;key encipherment&quot;,</span></span><br><span class="line"><span class="string">            &quot;client auth&quot;</span></span><br><span class="line"><span class="string">            ]</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;peer&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;expiry&quot;: &quot;175200h&quot;,</span></span><br><span class="line"><span class="string">            &quot;usages&quot;: [</span></span><br><span class="line"><span class="string">            &quot;signing&quot;,</span></span><br><span class="line"><span class="string">            &quot;key encipherment&quot;,</span></span><br><span class="line"><span class="string">            &quot;server auth&quot;,</span></span><br><span class="line"><span class="string">            &quot;client auth&quot;</span></span><br><span class="line"><span class="string">            ]</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">cat &gt;/opt/certs/etcd-peer-csr.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;CN&quot;: &quot;k8s-etcd&quot;,</span></span><br><span class="line"><span class="string">    &quot;hosts&quot;: [</span></span><br><span class="line"><span class="string">        &quot;192.168.82.27&quot;,</span></span><br><span class="line"><span class="string">        &quot;192.168.82.28&quot;,</span></span><br><span class="line"><span class="string">        &quot;192.168.82.29&quot;,</span></span><br><span class="line"><span class="string">        &quot;192.168.82.30&quot;,</span></span><br><span class="line"><span class="string">        &quot;192.168.82.31&quot;</span></span><br><span class="line"><span class="string">    ],</span></span><br><span class="line"><span class="string">    &quot;key&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class="line"><span class="string">        &quot;size&quot;: 2048</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;names&quot;: [</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class="line"><span class="string">        &quot;ST&quot;: &quot;shanghai&quot;,</span></span><br><span class="line"><span class="string">        &quot;L&quot;: &quot;shanghai&quot;,</span></span><br><span class="line"><span class="string">        &quot;O&quot;: &quot;lianjie&quot;,</span></span><br><span class="line"><span class="string">        &quot;OU&quot;: &quot;ops&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer etcd-peer-csr.json |cfssl-json -bare etcd-peer</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="配置etcd集群"><a href="#配置etcd集群" class="headerlink" title="配置etcd集群"></a>配置etcd集群</h2><p>下载etcd执行文件解压到/opt/etcd下，并下载证书</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">useradd -s /sbin/nologin -M etcd</span><br><span class="line">mkdir -p /opt/etcd/certs /data/etcd /data/logs/etcd-server</span><br><span class="line"><span class="built_in">cd</span> /opt/etcd/certs/</span><br><span class="line">wget http://yaml.bst.com/certs/ca.pem</span><br><span class="line">wget http://yaml.bst.com/certs/etcd-peer-key.pem</span><br><span class="line">wget http://yaml.bst.com/certs/etcd-peer.pem</span><br><span class="line">chmod 600 etcd-peer-key.pem</span><br><span class="line">chown -R etcd.etcd /opt/etcd</span><br><span class="line">chown -R etcd.etcd /opt/etcd-v3.2.32/</span><br><span class="line">chown -R etcd.etcd /data/logs/etcd-server/</span><br><span class="line">chown -R etcd.etcd /data/etcd</span><br></pre></td></tr></table></figure>

<p>配置sh文件，每一台etcd节点配置文件稍有有不同，关注name、listen-peer-urls、initial-advertise-peer-urls</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/opt/etcd/etcd-server-startup.sh &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">./etcd \</span><br><span class="line">--name etcd-server-82-29 \</span><br><span class="line">--data-dir /data/etcd/etcd-server \</span><br><span class="line">--listen-peer-urls https://192.168.82.29:2380 \</span><br><span class="line">--listen-client-urls https://192.168.82.29:2379,http://127.0.0.1:2379 \</span><br><span class="line">--quota-backend-bytes 8000000000 \</span><br><span class="line">--initial-advertise-peer-urls https://192.168.82.29:2380 \</span><br><span class="line">--advertise-client-urls https://192.168.82.29:2379,http://127.0.0.1:2379 \</span><br><span class="line">--initial-cluster etcd-server-82-27=https://192.168.82.27:2380,etcd-server-82-28=https://192.168.82.28:2380,etcd-server-82-29=https://192.168.82.29:2380 \</span><br><span class="line">--ca-file ./certs/ca.pem \</span><br><span class="line">--cert-file ./certs/etcd-peer.pem \</span><br><span class="line">--key-file ./certs/etcd-peer-key.pem \</span><br><span class="line">--client-cert-auth \</span><br><span class="line">--trusted-ca-file ./certs/ca.pem \</span><br><span class="line">--peer-ca-file ./certs/ca.pem \</span><br><span class="line">--peer-cert-file ./certs/etcd-peer.pem \</span><br><span class="line">--peer-key-file ./certs/etcd-peer-key.pem \</span><br><span class="line">--peer-client-cert-auth \</span><br><span class="line">--peer-trusted-ca-file ./certs/ca.pem \</span><br><span class="line">--log-output stdout</span><br><span class="line">EOF</span><br><span class="line">chmod +x /opt/etcd/etcd-server-startup.sh</span><br></pre></td></tr></table></figure>

<p>配置supervisor管理文件，并启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/etc/supervisord.d/etcd-server.ini &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[program:etcd-server] ; 显示的程序名,类型my.cnf,可以有多个</span></span><br><span class="line"><span class="string">command=sh /opt/etcd/etcd-server-startup.sh</span></span><br><span class="line"><span class="string">numprocs=1 ; 启动进程数 (def 1)</span></span><br><span class="line"><span class="string">directory=/opt/etcd ; 启动命令前切换的目录 (def no cwd)</span></span><br><span class="line"><span class="string">autostart=true ; 是否自启 (default: true)</span></span><br><span class="line"><span class="string">autorestart=true ; 是否自动重启 (default: true)</span></span><br><span class="line"><span class="string">startsecs=30 ; 服务运行多久判断为成功(def. 1)</span></span><br><span class="line"><span class="string">startretries=3 ; 启动重试次数 (default 3)</span></span><br><span class="line"><span class="string">exitcodes=0,2 ; 退出状态码 (default 0,2)</span></span><br><span class="line"><span class="string">stopsignal=QUIT ; 退出信号 (default TERM)</span></span><br><span class="line"><span class="string">stopwaitsecs=10 ; 退出延迟时间 (default 10)</span></span><br><span class="line"><span class="string">user=etcd ; 运行用户</span></span><br><span class="line"><span class="string">redirect_stderr=true ; 是否重定向错误输出到标准输出(def false)</span></span><br><span class="line"><span class="string">stdout_logfile=/data/logs/etcd-server/etcd.stdout.log</span></span><br><span class="line"><span class="string">stdout_logfile_maxbytes=64MB ; 日志文件大小 (default 50MB)</span></span><br><span class="line"><span class="string">stdout_logfile_backups=4 ; 日志文件滚动个数 (default 10)</span></span><br><span class="line"><span class="string">stdout_capture_maxbytes=1MB ; 设定capture管道的大小(default 0)</span></span><br><span class="line"><span class="string">;子进程还有子进程,需要添加这个参数,避免产生孤儿进程</span></span><br><span class="line"><span class="string">killasgroup=true</span></span><br><span class="line"><span class="string">stopasgroup=true</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment">## 启动服务，检查etcd集群是否正常</span></span><br><span class="line">supervisorctl update</span><br><span class="line">supervisorctl status</span><br><span class="line">netstat -lntup|grep etcd</span><br><span class="line">/opt/etcd/etcdctl cluster-health</span><br><span class="line">/opt/etcd/etcdctl member list</span><br></pre></td></tr></table></figure>



</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/11/30/docker%E8%BF%90%E8%A1%8Cnginx%E9%85%8D%E7%BD%AE%E8%AF%81%E4%B9%A6/">docker运行nginx配置证书</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-11-30</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/nginx/">nginx</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/docker/">docker</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/ssl/">ssl</a></span><div class="content"><h2 id="拉取nginx镜像"><a href="#拉取nginx镜像" class="headerlink" title="拉取nginx镜像"></a>拉取nginx镜像</h2><p><code>docker pull nginx</code></p>
<h2 id="初始化运行"><a href="#初始化运行" class="headerlink" title="初始化运行"></a>初始化运行</h2><p><code>docker run -p 443:443 -p 80:80 --name nginx \ -v /data/nginx/html:/usr/share/nginx/html \ -v /data/nginx/logs:/var/log/nginx \ -v /data/nginx/conf/nginx.conf:/etc/nginx/nginx.conf \ -v /data/nginx/conf/cert:/etc/nginx/cert \ -v /etc/localtime:/etc/localtime \ -d nginx</code></p>
<p>分别映射nginx的html、log、config</p>
<p>预期会启动失败，因为/data/nginx/conf/nginx.conf : /etc/nginx/nginx.conf docker会默认mount一个文件夹，实际上是个文件</p>
<p><code>rm -rf /data/nginx/config/nginx.conf</code></p>
<p>创建正确的nginx配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">error_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log warn;</span><br><span class="line">pid        &#x2F;var&#x2F;run&#x2F;nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    default_type  application&#x2F;octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span><br><span class="line">                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span><br><span class="line">                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;</span><br><span class="line"></span><br><span class="line">    #access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    gzip  on;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	  server &#123;</span><br><span class="line">		listen	443;   #监听端口，ssl默认443端口。如果需要配置多个端口，可以继续添加server，用不同的端口就行</span><br><span class="line">    #证书文件名称</span><br><span class="line">    ssl_certificate #.crt; </span><br><span class="line">    #私钥文件名称</span><br><span class="line">    ssl_certificate_key #.key; </span><br><span class="line">    ssl_session_timeout 5m;</span><br><span class="line">    #请按照以下协议配置</span><br><span class="line">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2; </span><br><span class="line">    #请按照以下套件配置，配置加密套件，写法遵循 openssl 标准。</span><br><span class="line">    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE; </span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line">    </span><br><span class="line">    server_name  ;   #服务器域名，需要和申请的证书匹配</span><br><span class="line">		</span><br><span class="line">		location &#x2F; &#123;</span><br><span class="line">			root  &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;  #网站根目录，和容器创建时指定的位置一致</span><br><span class="line">			index index.html index.htm;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	# 301默认跳转到443</span><br><span class="line">  server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    #填写绑定证书的域名</span><br><span class="line">    server_name www.jq1024.com jq1024.com;</span><br><span class="line">    #把http的域名请求转成https</span><br><span class="line">    return 301 https:&#x2F;&#x2F;$host$request_uri;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="重新运行"><a href="#重新运行" class="headerlink" title="重新运行"></a>重新运行</h2><p><code>docker restart nginx</code></p>
<p>done</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/11/26/%E6%9E%84%E5%BB%BAcentos7-jdk1-8%E7%9A%84docker%E9%95%9C%E5%83%8F/">构建centos7+jdk1.8的docker镜像</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-11-26</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/docker/">docker</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/java/">java</a></span><div class="content"><h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><p>由于Oracle JAVA不是开源的，所以你在Docker Hub是找不到基于Oracle JAVA 的开源容器，由于目前现状来说，多数开发者还是基于Oracle java版本进行开发和运行。所以为了避免发生未知的错误，多数企业都会自己构建基于Oracle JAVA的容器。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><ol>
<li>阿里云Docker镜像私有化空间</li>
<li>一台已经安装Docker服务的机器</li>
<li>下载最新的Oracle Jdk1.8 </li>
</ol>
<h2 id="开始构建"><a href="#开始构建" class="headerlink" title="开始构建"></a>开始构建</h2><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 依赖上层镜像</span></span><br><span class="line"><span class="keyword">FROM</span> centos:centos7</span><br><span class="line"><span class="comment"># Dockerfile作者</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> acshmily <span class="string">&quot;github.com/acshmily&quot;</span></span><br><span class="line"><span class="comment"># 创建目录</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir /usr/<span class="built_in">local</span>/jdk</span></span><br><span class="line"><span class="comment"># 设置工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /usr/<span class="built_in">local</span>/jdk</span></span><br><span class="line"><span class="comment"># 解压到 /usr/local/jdk下</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> jdk-8u271-linux-x64.tar.gz /usr/<span class="built_in">local</span>/jdk</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装必要的语言环境以及网络工具，安装完毕后清理缓存</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum update -y &amp;&amp; \</span></span><br><span class="line"><span class="bash">yum reinstall -y glibc-common &amp;&amp; \</span></span><br><span class="line"><span class="bash">yum install kde-l10n-Chinese -y &amp;&amp; \</span></span><br><span class="line"><span class="bash">yum install -y telnet net-tools &amp;&amp; \</span></span><br><span class="line"><span class="bash">yum clean all &amp;&amp; \</span></span><br><span class="line"><span class="bash">rm -rf /tmp/* rm -rf /var/cache/yum/* &amp;&amp; \</span></span><br><span class="line"><span class="bash">localedef -c -f UTF-8 -i zh_CN zh_CN.UTF-8 &amp;&amp; \</span></span><br><span class="line"><span class="bash">ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME /usr/local/jdk/jdk1.<span class="number">8.0</span>_271</span><br><span class="line"><span class="keyword">ENV</span> JRE_HOME /usr/local/jdk/jdk1.<span class="number">8.0</span>_271/jre</span><br><span class="line"><span class="keyword">ENV</span> PATH $JAVA_HOME/bin:$PATH</span><br><span class="line"><span class="keyword">ENV</span> LC_ALL zh_CN.UTF-<span class="number">8</span></span><br></pre></td></tr></table></figure>

<h2 id="发布镜像"><a href="#发布镜像" class="headerlink" title="发布镜像"></a>发布镜像</h2><ol>
<li>在阿里云创建一个空间（略）</li>
<li>登录阿里云Docker Registry</li>
<li><code>sudo docker tag [ImageId] Your Registry:[镜像版本号]</code></li>
<li><code>sudo docker push  Your Registry:[镜像版本号]</code></li>
</ol>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/11/23/java%E9%A1%B9%E7%9B%AE%E5%AE%9E%E7%8E%B0docker%E5%8C%96/">java项目实现docker化</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-11-23</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/docker/">docker</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/java/">java</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/springboot/">springboot</a></span><div class="content"><h2 id="Mac环境配置"><a href="#Mac环境配置" class="headerlink" title="Mac环境配置"></a>Mac环境配置</h2><p>由于我的Mac使用了<code>brew</code>管理相关组件，使用brew安装docker就可以了 </p>
<p><code>brew cash install docker</code></p>
<p>安装完毕后</p>
<p>运行<code>brew verison</code>应该会正常显示docker的相关信息，由于docker安装的时候hub默认为hub.docker.com，国内访问比较缓慢，为了更好的开发效率，进行国内镜像配置，具体可以自行google，推荐 阿里云、网易云等开源服务</p>
<p><img src="image-20201123164037294.png" alt="image-20201123164037294"></p>
<h2 id="项目调整"><a href="#项目调整" class="headerlink" title="项目调整"></a>项目调整</h2><ol>
<li>在项目所属的pom文件内添加docker相关maven插件</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Docker maven plugin --&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spotify<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docker-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">imageName</span>&gt;</span>$&#123;project.groupId&#125;/$&#123;project.artifactId&#125;:$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">imageName</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">dockerDirectory</span>&gt;</span>src/main/resources/docker<span class="tag">&lt;/<span class="name">dockerDirectory</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">targetPath</span>&gt;</span>/<span class="tag">&lt;/<span class="name">targetPath</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$&#123;project.build.directory&#125;<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">include</span>&gt;</span>$&#123;project.build.finalName&#125;.jar<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!-- Docker maven plugin --&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在相关项目路径src/main/resources/docker 下 创建Dockerfile文件，例如</li>
</ol>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> java:<span class="number">8</span></span><br><span class="line"><span class="comment"># 作者</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> 名字 <span class="string">&quot;邮箱&quot;</span></span><br><span class="line"><span class="comment"># 设置容器卷</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> /tmp</span></span><br><span class="line"><span class="comment"># 设置容器卷</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> /data/logs</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> 项目.jar /app.jar</span></span><br><span class="line"><span class="comment"># 入口</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">&quot;java&quot;</span>,<span class="string">&quot;-Djava.security.egd=file:/dev/./urandom&quot;</span>,<span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;/app.jar&quot;</span>]</span></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;Asia/Shanghai&#x27;</span> &gt;/etc/timezone</span></span><br><span class="line"><span class="comment"># 暴露端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8000</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>创建镜像</li>
</ol>
<p>由于我的项目是多模块项目，需要先进行jar的相关编译打包，后进行docker镜像创建，分为两部</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn package -Dmaven.test.skip=true</span><br></pre></td></tr></table></figure>

<p>后在相关模块内再执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn docker:build</span><br></pre></td></tr></table></figure>

<p>如果是单项目则直接可以执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn package docker:build -Dmaven.test.skip&#x3D;true </span><br></pre></td></tr></table></figure>

<ol start="4">
<li>导出镜像</li>
</ol>
<p>由于生产环境可能对于docker的支持不够充分，特别是私有hub管理容器之类的，此时需要手动导出相关镜像，在生产环境手动导入</p>
<p><code>docker images</code>后会列出你已经编译好的镜像id，我们需要进行相关的导出，此处有坑，如果使用默认save则导入生产环境的时候你的REPOSITORY 和 tag 都会是 <em><none></em> ，不利于后期维护。我们需要完整指定导出</p>
<p><code> docker save  -o ./target/打包名.tar REPOSITORY:tag</code> </p>
<ol start="5">
<li>生产导入</li>
</ol>
<p>生产环境也必须具备docker环境，将镜像包上传后进行收工导入</p>
<p><code>docker load -i 打包名.jar</code> ，导入完毕后执行 <code>docker images</code> 确认是否与开发环境一致</p>
<ol start="6">
<li>启动</li>
</ol>
<p>由于docker可以启动多个镜像实例，所以启动命令比较复杂</p>
<p><code>sudo docker run --name 8001 -d -e &quot;SPRING_PROFILES_ACTIVE=pre&quot; -p 8001:8000 -v /data/logs/8001:/data/logs  REPOSITORY:tag</code></p>
<p>说明：</p>
<p>–name 代表容器名，便于定位是哪个实例</p>
<p>-d 后台运行</p>
<p>-e 环境变量，由于我是springboot项目，我可以动态指定我配置文件生效的标签</p>
<p>-p 对外暴露端口关联 宿主机端口:容器实例端口</p>
<p>-v 映射卷，项目日志想挂载出来 宿主机的 /data/logs/8001 对应容器的/data/logs</p>
<p>在测试环境启动遇到问题，现象为 在容器内可以访问该端口接口，在宿主机和其他机器都无法访问。STFW后确认了应该是网卡问题，按照方法进行了网卡重新生成</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 停止服务</span></span><br><span class="line">systemctl stop docker</span><br><span class="line"><span class="meta">#</span><span class="bash"> 停用网卡</span></span><br><span class="line">ip link set dev docker0 down</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除桥接网卡</span></span><br><span class="line">brctl delbr docker0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 新增桥接网卡</span></span><br><span class="line">brctl addbr docker0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 为桥接网卡设置ip</span></span><br><span class="line">ip addr add 172.16.10.1/24 dev docker0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启用网卡</span></span><br><span class="line">ip link set dev docker0 up</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启用docker</span></span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>



</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/11/12/Redis%E9%9B%86%E7%BE%A4%E8%B8%A9%E5%9D%91%E7%AC%94%E8%AE%B0/">Redis集群踩坑笔记</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-11-12</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Redis/">Redis</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Springboot/">Springboot</a></span><div class="content"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>​        由于安全小组对于内网环境要求升级，对于原先的Redis集群需要进行IP过滤以及密码设置。由于之前开发同事部署集群的时候并未设置密码，选择了一个良辰吉日进行了密码设置然后重启了Redis服务，后面有意思的事情就来了T.T</p>
<h2 id="Spring-Boot多集群配置"><a href="#Spring-Boot多集群配置" class="headerlink" title="Spring Boot多集群配置"></a>Spring Boot多集群配置</h2><p>​        由于我们将缓存服务抽象成了一个服务层，这个服务层对应用服务器暴露标准接口进行数据存储调用，在Spring Boot2.3.3及以下版本由于RedisTemplate自动配置其实是存在缺陷的。</p>
<p>缺陷一：需要手动开启刷新拓扑配置</p>
<p>缺陷二：需要手动开启自动自适应</p>
<p>由于之前集群都并未设置密码，所以原先的代码片段为</p>
<figure class="highlight groovy"><figcaption><span>diff</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> RedisConnectionFactory buildRedisConnectionFactory(RedisProperties redisProperty) &#123;</span><br><span class="line">        <span class="keyword">if</span> (redisProperty == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//创建默认的redis连接工厂</span></span><br><span class="line">            LettuceConnectionFactory defaultConnectionFactory = createDefaultConnectionFactory()</span><br><span class="line">            defaultConnectionFactory.afterPropertiesSet()</span><br><span class="line">            <span class="keyword">return</span> defaultConnectionFactory</span><br><span class="line">        &#125;</span><br><span class="line">        LettuceClientConfiguration clientConfig</span><br><span class="line">        <span class="comment">//创建lettuce连接工厂</span></span><br><span class="line">        LettuceConnectionFactory redisConnectionFactory</span><br><span class="line">        <span class="keyword">if</span> (getRedisMode(redisProperty) == RedisModeEnum.CLUSTER) &#123;</span><br><span class="line">            <span class="comment">//支持自适应集群拓扑刷新和静态刷新源</span></span><br><span class="line"></span><br><span class="line">            ClusterTopologyRefreshOptions clusterTopologyRefreshOptions = ClusterTopologyRefreshOptions.builder()</span><br><span class="line">                    .enablePeriodicRefresh()</span><br><span class="line">                    .enableAdaptiveRefreshTrigger(ClusterTopologyRefreshOptions.RefreshTrigger.PERSISTENT_RECONNECTS, ClusterTopologyRefreshOptions.RefreshTrigger.MOVED_REDIRECT)</span><br><span class="line">                    .build()</span><br><span class="line">            ClusterClientOptions clusterClientOptions = ClusterClientOptions.builder().topologyRefreshOptions(clusterTopologyRefreshOptions).build()</span><br><span class="line"></span><br><span class="line">            clientConfig = buildLettuceClientConfiguration(DefaultClientResources.create(),</span><br><span class="line">                    redisProperty.getLettuce().getPool(), redisProperty, clusterClientOptions)</span><br><span class="line">            redisConnectionFactory = <span class="keyword">new</span> LettuceConnectionFactory(<span class="keyword">new</span> RedisClusterConfiguration(redisProperty.getCluster().getNodes()), clientConfig)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getRedisMode(redisProperty) == RedisModeEnum.SENTINEL) &#123;</span><br><span class="line">            clientConfig = buildLettuceClientConfiguration(DefaultClientResources.create(),</span><br><span class="line">                    redisProperty.getLettuce().getPool(), redisProperty)</span><br><span class="line">            redisConnectionFactory = <span class="keyword">new</span> LettuceConnectionFactory(<span class="keyword">new</span> RedisSentinelConfiguration</span><br><span class="line">                    (redisProperty.getSentinel().getMaster(), <span class="keyword">new</span> HashSet&lt;&gt;(redisProperty.getSentinel().getNodes())), clientConfig)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            clientConfig = buildLettuceClientConfiguration(DefaultClientResources.create(),</span><br><span class="line">                    redisProperty.getLettuce().getPool(), redisProperty)</span><br><span class="line">            redisConnectionFactory = <span class="keyword">new</span> LettuceConnectionFactory(<span class="keyword">new</span> RedisStandaloneConfiguration</span><br><span class="line">                    (redisProperty.getHost(), redisProperty.getPort()), clientConfig)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        redisConnectionFactory.afterPropertiesSet()</span><br><span class="line">        <span class="keyword">return</span> redisConnectionFactory</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>当Redis设置密码以后刷新Redis会一直提示</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NOAUTH Authentication required</span><br></pre></td></tr></table></figure>

<p>后发现存在配置文件内设置的password并没有自动注入设置进去，需要手动设置，在Spring Boot 2.3.5后该问题依然未解决，但已经自动处理了自动刷新拓扑和自适应</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">protected RedisConnectionFactory buildRedisConnectionFactory(RedisProperties redisProperty) &#123;</span><br><span class="line">        if (redisProperty == null) &#123;</span><br><span class="line">            //创建默认的redis连接工厂</span><br><span class="line">            LettuceConnectionFactory defaultConnectionFactory = createDefaultConnectionFactory()</span><br><span class="line">            defaultConnectionFactory.afterPropertiesSet()</span><br><span class="line">            return defaultConnectionFactory</span><br><span class="line">        &#125;</span><br><span class="line">        LettuceClientConfiguration clientConfig</span><br><span class="line">        //创建lettuce连接工厂</span><br><span class="line">        LettuceConnectionFactory redisConnectionFactory</span><br><span class="line">        if (getRedisMode(redisProperty) == RedisModeEnum.CLUSTER) &#123;</span><br><span class="line">            //支持自适应集群拓扑刷新和静态刷新源</span><br><span class="line"></span><br><span class="line">            ClusterTopologyRefreshOptions clusterTopologyRefreshOptions = ClusterTopologyRefreshOptions.builder()</span><br><span class="line">                    .enablePeriodicRefresh()</span><br><span class="line">                    .enableAdaptiveRefreshTrigger(ClusterTopologyRefreshOptions.RefreshTrigger.PERSISTENT_RECONNECTS, ClusterTopologyRefreshOptions.RefreshTrigger.MOVED_REDIRECT)</span><br><span class="line">                    .build()</span><br><span class="line">            ClusterClientOptions clusterClientOptions = ClusterClientOptions.builder().topologyRefreshOptions(clusterTopologyRefreshOptions).build()</span><br><span class="line"></span><br><span class="line">            clientConfig = buildLettuceClientConfiguration(DefaultClientResources.create(),</span><br><span class="line">                    redisProperty.getLettuce().getPool(), redisProperty, clusterClientOptions)</span><br><span class="line"><span class="addition">+            RedisClusterConfiguration config</span></span><br><span class="line"><span class="addition">+            if(StringUtils.isNotBlank(redisProperty.password))&#123;</span></span><br><span class="line"><span class="addition">+                config = new RedisClusterConfiguration(redisProperty.getCluster().getNodes())</span></span><br><span class="line"><span class="addition">+                log.info(&#x27;设置Redis密码:&#123;&#125;&#x27;,redisProperty.password)</span></span><br><span class="line"><span class="addition">+                config.setPassword(redisProperty.password)</span></span><br><span class="line"><span class="addition">+           &#125;else&#123;</span></span><br><span class="line"><span class="addition">+                config = new RedisClusterConfiguration(redisProperty.getCluster().getNodes())</span></span><br><span class="line"><span class="addition">+            &#125;</span></span><br><span class="line"><span class="deletion">-            redisConnectionFactory = new LettuceConnectionFactory(new RedisClusterConfiguration(redisProperty.getCluster().getNodes()), clientConfig)</span></span><br><span class="line"><span class="addition">+						 redisConnectionFactory = new LettuceConnectionFactory( config , clientConfig)</span></span><br><span class="line">        &#125; else if (getRedisMode(redisProperty) == RedisModeEnum.SENTINEL) &#123;</span><br><span class="line">            clientConfig = buildLettuceClientConfiguration(DefaultClientResources.create(),</span><br><span class="line">                    redisProperty.getLettuce().getPool(), redisProperty)</span><br><span class="line">            redisConnectionFactory = new LettuceConnectionFactory(new RedisSentinelConfiguration</span><br><span class="line">                    (redisProperty.getSentinel().getMaster(), new HashSet&lt;&gt;(redisProperty.getSentinel().getNodes())), clientConfig)</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            clientConfig = buildLettuceClientConfiguration(DefaultClientResources.create(),</span><br><span class="line">                    redisProperty.getLettuce().getPool(), redisProperty)</span><br><span class="line">            redisConnectionFactory = new LettuceConnectionFactory(new RedisStandaloneConfiguration</span><br><span class="line">                    (redisProperty.getHost(), redisProperty.getPort()), clientConfig)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        redisConnectionFactory.afterPropertiesSet()</span><br><span class="line">        return redisConnectionFactory</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="是不是忘记了设置Redis集群的密码？"><a href="#是不是忘记了设置Redis集群的密码？" class="headerlink" title="是不是忘记了设置Redis集群的密码？"></a>是不是忘记了设置Redis集群的密码？</h2><p>​        好了，Redis集群在代码侧配置可以正常启动并且查询数据了，但是后面遇到个诡异的现象。可以查数据，但是无法更新数据！Why？当时的定位思路：</p>
<ul>
<li>是不是Redis连接工厂配置有问题？</li>
<li>查看RedisTemplate 的set操作有没有异常</li>
<li>检查集群是否正常</li>
</ul>
<p>结论：</p>
<ul>
<li>我进行了本地debug跟踪和复现，发现无法复现该问题，并且如果密码设置有问题的话应该也无法查出数据，排除该项</li>
<li>由于我们的服务对RedisTemplate进行了封装，基本都有try…catch，日志上并未体现异常捕获，故对于RedisTemplate来说操作都是正常的</li>
<li>那么，问题就应该出现在集群上了，经过与Redis负责部署维护的同事确认，他之前只设置了每个节点的Redis密码，并未设置<strong>集群密码</strong> ，后确认就是该问题导致出现了这么诡异的现象</li>
</ul>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><ol>
<li>对于RedisTemplate的操作是否成功现在不能完全依赖有没有报错，对于忘记设置集群密码的集群，RedisTemplate操作set并不会报错，这样会让人造成困惑，无法判断到底是哪儿出了问题</li>
<li>不能盲目信任Spring Boot的AutoConfigure方法，有可能会忘记帮你set了password（单集群除外）</li>
<li>RTFM、STFW也不好使</li>
</ol>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/11/05/sip%E5%91%BC%E8%BD%AC%E9%97%AE%E9%A2%98/">sip呼转问题</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-11-05</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/">工作笔记</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/SIP/">SIP</a></span><div class="content"><h1 id="关于SIP语音呼转问题"><a href="#关于SIP语音呼转问题" class="headerlink" title="关于SIP语音呼转问题"></a>关于SIP语音呼转问题</h1><p>​    记录一下，模拟大网呼转的时候History-info 字段必须规范，必须使用sip tag 包装主叫、被叫、并且携带IMS@域。不可用tel tag.</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/05/08/http-redis/">http-redis</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-05-08</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/">工作笔记</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/redis/">redis</a></span><div class="content"><h1 id="内存持久化方案"><a href="#内存持久化方案" class="headerlink" title="内存持久化方案"></a>内存持久化方案</h1><h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h2><p>​        方案底层不限于Redis、FastCache、Memcache。应剥离及封装底层；对外暴露为HTTP接口或Socket接口进行能力封装；</p>
<p>​        键统一采用”prefix_主叫号码”风格进行约束</p>
<h2 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h2><p>###方案一 JSON序列化</p>
<p>优点：序列化后在终端内查看直观</p>
<p>缺点：全部业务系统统一采用同一个JSON对象进行序列化及反序列化，拓展性不好</p>
<p>###方案二 采用特定约束字符串分隔</p>
<p>优点：无限拓展（只要定义好顺序）</p>
<p>缺点：终端内不直观</p>
<h2 id="持久化测试对比"><a href="#持久化测试对比" class="headerlink" title="持久化测试对比"></a>持久化测试对比</h2><p>将同等数量级的数据进行以上两组的序列化及反序列化调用测试QPS时间</p>
<p>约定JSON对象</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">beans</span>&#123;</span></span><br><span class="line">  String type <span class="comment">// 开关</span></span><br><span class="line">  String prd1 <span class="comment">// 产品功能1</span></span><br><span class="line">  String prd2 <span class="comment">// 产品功能2</span></span><br><span class="line">  String prd3 <span class="comment">// 产品功能3</span></span><br><span class="line">  String prd4 <span class="comment">// 产品功能4</span></span><br><span class="line">  String prd5 <span class="comment">// 产品功能5</span></span><br><span class="line">  String prd6 <span class="comment">// 产品功能6</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>约定特定分隔符</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type|prd1|prd2|prd3|prd4|prd5|prd6</span><br></pre></td></tr></table></figure>

<p>测试代码</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> @Author: Huanghz</span></span><br><span class="line"><span class="comment"> @Description: TODO</span></span><br><span class="line"><span class="comment"> @Date:Created in 10:03 上午 2020/5/7</span></span><br><span class="line"><span class="comment"> @ModifyBy:</span></span><br><span class="line"><span class="comment">  * */</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Beans</span> <span class="keyword">implements</span> <span class="title">RedisSerializerType</span> &#123;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    String type</span><br><span class="line">    <span class="keyword">boolean</span> prd1</span><br><span class="line">    String prd2</span><br><span class="line">    <span class="keyword">boolean</span> prd3</span><br><span class="line">    <span class="keyword">boolean</span> prd4</span><br><span class="line">    <span class="keyword">boolean</span> prd5</span><br><span class="line">    <span class="keyword">boolean</span> prd6</span><br><span class="line"></span><br><span class="line">    Beans(String type, <span class="keyword">boolean</span> prd1, String prd2, <span class="keyword">boolean</span> prd3, <span class="keyword">boolean</span> prd4, <span class="keyword">boolean</span> prd5, <span class="keyword">boolean</span> prd6) &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = type</span><br><span class="line">        <span class="built_in">this</span>.prd1 = prd1</span><br><span class="line">        <span class="built_in">this</span>.prd2 = prd2</span><br><span class="line">        <span class="built_in">this</span>.prd3 = prd3</span><br><span class="line">        <span class="built_in">this</span>.prd4 = prd4</span><br><span class="line">        <span class="built_in">this</span>.prd5 = prd5</span><br><span class="line">        <span class="built_in">this</span>.prd6 = prd6</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Beans() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String toRedisValue() &#123;</span><br><span class="line">        <span class="keyword">def</span> sb = <span class="keyword">new</span> StringBuffer()</span><br><span class="line">        <span class="built_in">this</span>.<span class="keyword">class</span>.declaredFields.findAll &#123; !it.synthetic &amp;&amp; !Modifier.isStatic(it.modifiers) &#125;.each &#123;</span><br><span class="line">            sb.append(<span class="built_in">this</span>.<span class="string">&quot;$it.name&quot;</span>).append(<span class="string">&#x27;|&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        sb.deleteCharAt(sb.lastIndexOf(<span class="string">&#x27;|&#x27;</span>))</span><br><span class="line">        <span class="keyword">return</span> sb.toString()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Beans getInstance(String redisValue) &#123;</span><br><span class="line">        instance = <span class="keyword">new</span> Beans()</span><br><span class="line">        <span class="keyword">def</span> point = <span class="number">0</span></span><br><span class="line">        <span class="keyword">def</span> values = redisValue.split(<span class="string">&#x27;\\|&#x27;</span>)</span><br><span class="line">        instance.<span class="keyword">class</span>.declaredFields.findAll &#123; !it.synthetic &amp;&amp; !Modifier.isStatic(it.modifiers) &#125;.each &#123;</span><br><span class="line">            it.setAccessible(<span class="literal">true</span>)</span><br><span class="line">            <span class="keyword">switch</span> (it.type.name) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;boolean&#x27;</span>:</span><br><span class="line">                    instance.setProperty(it.name,values[point].toUpperCase() == <span class="string">&#x27;TRUE&#x27;</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="symbol">default:</span></span><br><span class="line">                    instance.setProperty(it.name,values[point])</span><br><span class="line">            &#125;</span><br><span class="line">            point++</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Beans instance</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> cn._118114.hangup</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn._118114.hangup.beans.RedisSerializerType</span><br><span class="line"><span class="keyword">import</span> groovy.transform.ToString</span><br><span class="line"><span class="keyword">import</span> groovy.util.logging.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @Author: Huanghz</span></span><br><span class="line"><span class="comment"> * @Description: Json序列化和反序列化测试</span></span><br><span class="line"><span class="comment"> * @Date:Created in 4:54 下午 2020/5/6</span></span><br><span class="line"><span class="comment"> * @ModifyBy:</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JsonTest</span> &#123;</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> _PREFIX = <span class="string">&#x27;json_&#x27;</span></span><br><span class="line">    <span class="comment">// 定义beans</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> flush() &#123;</span><br><span class="line">        <span class="keyword">def</span> beans = <span class="keyword">new</span> Beans()</span><br><span class="line">        beans.type = <span class="string">&#x27;test&#x27;</span></span><br><span class="line">        beans.prd2 = <span class="string">&#x27;prd2&#x27;</span></span><br><span class="line">        log.info(<span class="string">&#x27;开始循环插入Redis&#x27;</span>)</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">            redisTemplate.boundValueOps(_PREFIX + i).setIfAbsent(beans, <span class="number">5</span>, TimeUnit.MINUTES)</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&#x27;开始从Redis反序列化&#x27;</span>)</span><br><span class="line">        <span class="keyword">def</span> start = System.currentTimeMillis()</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">            beans = redisTemplate.boundValueOps(_PREFIX + i).get()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">def</span> end = System.currentTimeMillis()</span><br><span class="line">        log.info(<span class="string">&#x27;读取结束，消耗时间:&#123;&#125;&#x27;</span>, end - start)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> flush1() &#123;</span><br><span class="line">        <span class="keyword">def</span> beans = <span class="keyword">new</span> Beans()</span><br><span class="line">        beans.type = <span class="string">&#x27;test&#x27;</span></span><br><span class="line">        beans.prd2 = <span class="string">&#x27;prd2&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">100000</span>; i &lt; <span class="number">200000</span>; i++) &#123;</span><br><span class="line">            redisTemplate.boundValueOps(_PREFIX + i).setIfAbsent(beans.toRedisValue(), <span class="number">5</span>, TimeUnit.MINUTES)</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&#x27;开始从Redis反序列化&#x27;</span>)</span><br><span class="line">        <span class="keyword">def</span> start = System.currentTimeMillis()</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">100000</span>; i &lt; <span class="number">200000</span>; i++) &#123;</span><br><span class="line">            beans = Beans.getInstance(redisTemplate.boundValueOps(_PREFIX + i).get() <span class="keyword">as</span> String)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">def</span> end = System.currentTimeMillis()</span><br><span class="line">        log.info(<span class="string">&#x27;读取结束，消耗时间:&#123;&#125;&#x27;</span>, end - start)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="JSON序列化方案耗时"><a href="#JSON序列化方案耗时" class="headerlink" title="JSON序列化方案耗时"></a>JSON序列化方案耗时</h3><p>测试10W条序列化反序列化耗时日志</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">13</span>:<span class="number">34</span>:<span class="number">19</span><span class="variable">.593</span>  INFO <span class="number">7458</span> --- [           main] cn<span class="variable">._118114</span><span class="variable">.hangup</span><span class="variable">.JsonTest</span>               : 开始循环插入Redis</span><br><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">13</span>:<span class="number">34</span>:<span class="number">20</span><span class="variable">.425</span>  INFO <span class="number">7458</span> --- [           main] io<span class="variable">.lettuce</span><span class="variable">.core</span><span class="variable">.EpollProvider</span>            : Starting without optional epoll <span class="keyword">library</span></span><br><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">13</span>:<span class="number">34</span>:<span class="number">20</span><span class="variable">.428</span>  INFO <span class="number">7458</span> --- [           main] io<span class="variable">.lettuce</span><span class="variable">.core</span><span class="variable">.KqueueProvider</span>           : Starting without optional kqueue <span class="keyword">library</span></span><br><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">13</span>:<span class="number">34</span>:<span class="number">33</span><span class="variable">.779</span>  INFO <span class="number">7458</span> --- [           main] cn<span class="variable">._118114</span><span class="variable">.hangup</span><span class="variable">.JsonTest</span>               : 开始从Redis反序列化</span><br><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">13</span>:<span class="number">34</span>:<span class="number">43</span><span class="variable">.346</span>  INFO <span class="number">7458</span> --- [           main] cn<span class="variable">._118114</span><span class="variable">.hangup</span><span class="variable">.JsonTest</span>               : 读取结束，消耗时间:<span class="number">9551</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="自定义约定序列化耗时"><a href="#自定义约定序列化耗时" class="headerlink" title="自定义约定序列化耗时"></a>自定义约定序列化耗时</h3><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">10</span>:<span class="number">52</span>:<span class="number">22</span><span class="variable">.303</span>  INFO <span class="number">6554</span> --- [           main] io<span class="variable">.lettuce</span><span class="variable">.core</span><span class="variable">.EpollProvider</span>            : Starting without optional epoll <span class="keyword">library</span></span><br><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">10</span>:<span class="number">52</span>:<span class="number">22</span><span class="variable">.311</span>  INFO <span class="number">6554</span> --- [           main] io<span class="variable">.lettuce</span><span class="variable">.core</span><span class="variable">.KqueueProvider</span>           : Starting without optional kqueue <span class="keyword">library</span></span><br><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">10</span>:<span class="number">52</span>:<span class="number">41</span><span class="variable">.667</span>  INFO <span class="number">6554</span> --- [           main] cn<span class="variable">._118114</span><span class="variable">.hangup</span><span class="variable">.JsonTest</span>               : 开始从Redis反序列化</span><br><span class="line"><span class="number">2020</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">10</span>:<span class="number">52</span>:<span class="number">56</span><span class="variable">.940</span>  INFO <span class="number">6554</span> --- [           main] cn<span class="variable">._118114</span><span class="variable">.hangup</span><span class="variable">.JsonTest</span>               : 读取结束，消耗时间:<span class="number">15256</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="基于HTTP-封装内存数据库"><a href="#基于HTTP-封装内存数据库" class="headerlink" title="基于HTTP 封装内存数据库"></a>基于HTTP 封装内存数据库</h2><p>GitHub测试项目地址：<a target="_blank" rel="noopener" href="https://github.com/acshmily/http-redis">https://github.com/acshmily/http-redis</a></p>
<p>测试框架：</p>
<p>​    Spring Boot 2.2.6、Redis连接池 Luttuce </p>
<p>配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">lettuce:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">8</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">8</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>压测结果：</p>
<img src="/2020/05/08/http-redis/jmeter.png" class="" title="jmeter压测结果"></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/10/15/centos-ulimit-modify/">centos-ulimit-modify</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-10-15</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/">工作笔记</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/linux/">linux</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/centos/">centos</a></span><div class="content"><h1 id="调整centos7的ulimit相关配置"><a href="#调整centos7的ulimit相关配置" class="headerlink" title="调整centos7的ulimit相关配置"></a>调整centos7的ulimit相关配置</h1><p>​    针对大并发以及分布式系统，系统默认的句柄数、最大线程数等需要进行修改，由于centos7下的sshd大版本为<strong>8</strong>的调整策略和以往不同，需要修改三处。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/security/limits.conf</span><br><span class="line">* soft nofile 40960</span><br><span class="line">* hard nofile 81920</span><br><span class="line">* soft nproc 40960</span><br><span class="line">* hard nproc 81920</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/pam.d/sshd</span><br><span class="line"><span class="meta">#</span><span class="bash">%PAM-1.0</span></span><br><span class="line">auth       include      system-auth</span><br><span class="line">account    required     pam_nologin.so</span><br><span class="line">account    include      system-auth</span><br><span class="line">password   include      system-auth</span><br><span class="line">session    optional     pam_keyinit.so force revoke</span><br><span class="line">session    include      system-auth</span><br><span class="line">session    required     pam_loginuid.so</span><br><span class="line">session    required     pam_limits.so</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/ssh/sshd_config  UsePAM  yes</span><br></pre></td></tr></table></figure>



<p>退出登录后重新登录，进行验证</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ulimit -n</span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/10/10/docker-jenkins-sonarqube/">docker-jenkins-sonarqube</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-10-10</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/">工作笔记</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/DevOPS/">DevOPS</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/jenkins/">jenkins</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/sonarqube/">sonarqube</a></span><div class="content"><h1 id="jenkins联动sonarQube"><a href="#jenkins联动sonarQube" class="headerlink" title="jenkins联动sonarQube"></a>jenkins联动sonarQube</h1><h2 id="版本信息"><a href="#版本信息" class="headerlink" title="版本信息"></a>版本信息</h2><ul>
<li>Centos 7 （安装epel-release）</li>
<li>Docker CE:Lastest TLS</li>
<li>Aliyun Docker Repository</li>
<li>Python Pip</li>
<li>Docker-Compose or K8S</li>
</ul>
<h2 id="Jenkins-in-Docker"><a href="#Jenkins-in-Docker" class="headerlink" title="Jenkins in Docker"></a>Jenkins in Docker</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -u root -d -p 8080:8080 -p 50000:50000 -v jenkins-data:/var/jenkins_home -v /var/run/docker.sock:/var/run/docker.sock -v /usr/java/maven:/usr/local/maven -e JAVA_OPTS=-Duser.timezone=Asia/Shanghai --name jenkins jenkins/jenkins:lts</span><br></pre></td></tr></table></figure>

<p>​    对外暴露 8080为Web 访问端口 50000为API调用端口</p>
<p>​    挂载宿主机容器卷 <strong>jenkis-data</strong> 对应容的的**/var/jenkins_home** 路径</p>
<p>​    挂载 <strong>/var/run/docker.sock</strong> 对应容器的 <strong>/var/run/docker.sock</strong> </p>
<p>​    挂载**/usr/java/maven** 对应容器的 <strong>/usr/local/maven</strong> </p>
<p>​    设置容器内JAVA额外配置参数时区为<strong>上海</strong> </p>
<p>​    命名该容器为 jenkins</p>
<p>​    该镜像更多用法可以访问hub.docker.com 访问 jenkins:lts 进行查看</p>
<h2 id="SonarQube-in-Docker"><a href="#SonarQube-in-Docker" class="headerlink" title="SonarQube in Docker"></a>SonarQube in Docker</h2><p>​    由于SonarQube的数据库推荐为<strong>Postgres</strong>，按照官方建议编写docker-compose.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">sonarqube:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">sonarqube</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9000:9000&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sonarnet</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SONARQUBE_JDBC_URL=jdbc:postgresql://db:5432/sonar</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sonarqube_conf:/opt/sonarqube/conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sonarqube_data:/opt/sonarqube/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sonarqube_extensions:/opt/sonarqube/extensions</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sonarqube_bundled-plugins:/opt/sonarqube/lib/bundled-plugins</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sonarqube_temp:/opt/sonarqube/temp</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sonarnet</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_USER=sonar</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_PASSWORD=sonar</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">postgresql:/var/lib/postgresql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">postgresql_data:/var/lib/postgresql/data</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">sonarnet:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">sonarqube_conf:</span></span><br><span class="line">  <span class="attr">sonarqube_data:</span></span><br><span class="line">  <span class="attr">sonarqube_extensions:</span></span><br><span class="line">  <span class="attr">sonarqube_bundled-plugins:</span></span><br><span class="line">  <span class="attr">postgresql:</span></span><br><span class="line">  <span class="attr">postgresql_data:</span></span><br></pre></td></tr></table></figure>

<p><strong>Note</strong></p>
<pre><code>- 你也可以将SonarQube的持久化数据库更换为MYSQL，但是注意最新版本的SonarQube不再支持MYSQL
- 更多的配置可以访问 hub.docker.com 搜索 sonarqube 进行查看
</code></pre>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> docker-compose.yml 当前路径下</span></span><br><span class="line">docker-compose up -d # 后台运行</span><br><span class="line">docker ps # 查看进程</span><br></pre></td></tr></table></figure>

<h2 id="Jenkins-插件安装"><a href="#Jenkins-插件安装" class="headerlink" title="Jenkins 插件安装"></a>Jenkins 插件安装</h2><p><strong>NOTE</strong> 由于国内访问jenkins官方源速度不够理想，建议更换为国内镜像，例如 清华镜像源</p>
<p>安装以下插件：</p>
<pre><code>- [Localization: Chinese (Simplified)](https://github.com/jenkinsci/localization-zh-cn-plugin)
- [SonarQube Scanner for Jenkins](http://redirect.sonarsource.com/plugins/jenkins.html)
- [Maven Integration plugin](https://wiki.jenkins.io/display/JENKINS/Maven+Project+Plugin)
- [Email Ext Recipients Column Plugin](https://wiki.jenkins-ci.org/display/JENKINS/Email+Ext+Recipients+Column+Plugin)
- [Git plugin](https://github.com/jenkinsci/git-plugin)
- [Git client plugin](https://github.com/jenkinsci/git-client-plugin)
- [GIT server Plugin](https://wiki.jenkins.io/display/JENKINS/Git+Server+Plugin)
</code></pre>
<p>##SonarQube 插件安装</p>
<ul>
<li>安装本地化语言插件</li>
</ul>
<h2 id="SonarQube-配置"><a href="#SonarQube-配置" class="headerlink" title="SonarQube 配置"></a>SonarQube 配置</h2><p>​    由于SCM轮询交由Jenkins处理，故关闭SCM轮询。</p>
<p>![image-20191010104017484](/Users/huanghongzhi/Library/Application Support/typora-user-images/image-20191010104017484.png)</p>
<h2 id="Jenkins-配置"><a href="#Jenkins-配置" class="headerlink" title="Jenkins 配置"></a>Jenkins 配置</h2><h3 id="配置-SonarQube-servers"><a href="#配置-SonarQube-servers" class="headerlink" title="配置 SonarQube servers"></a>配置 <strong>SonarQube servers</strong></h3><ul>
<li>Environment variables 设置为Enable</li>
<li>SonarQube installations <ul>
<li>name：Jenkins 内现实该servers 的名称</li>
<li>Server URL：SonarQube 的地址</li>
<li>Server authentication token：默认不填</li>
</ul>
</li>
</ul>
<h3 id="配置Extended-E-mail-Notification"><a href="#配置Extended-E-mail-Notification" class="headerlink" title="配置Extended E-mail Notification"></a>配置<strong>Extended E-mail Notification</strong></h3><ul>
<li>SMTP server </li>
<li>Default user E-mail suffix</li>
<li>Default Content Type ： 选择为HTML</li>
<li>Default Subject：标题</li>
<li>Default Content：内容</li>
</ul>
<p><strong>Default Subject</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">【系统自动发送，请勿回复】$PROJECT_NAME - Build # $BUILD_NUMBER - $BUILD_STATUS!</span><br></pre></td></tr></table></figure>

<p><strong>Default Content</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>$&#123;ENV, var=&quot;JOB_NAME&quot;&#125;-第$&#123;BUILD_NUMBER&#125;次构建日志<span class="tag">&lt;/<span class="name">title</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span>  </span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">leftmargin</span>=<span class="string">&quot;8&quot;</span> <span class="attr">marginwidth</span>=<span class="string">&quot;0&quot;</span> <span class="attr">topmargin</span>=<span class="string">&quot;8&quot;</span> <span class="attr">marginheight</span>=<span class="string">&quot;4&quot;</span>  </span></span><br><span class="line"><span class="tag"><span class="attr">offset</span>=<span class="string">&quot;0&quot;</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">width</span>=<span class="string">&quot;95%&quot;</span> <span class="attr">cellpadding</span>=<span class="string">&quot;0&quot;</span> <span class="attr">cellspacing</span>=<span class="string">&quot;0&quot;</span>  </span></span><br><span class="line"><span class="tag"><span class="attr">style</span>=<span class="string">&quot;font-size: 11pt; font-family: Tahoma, Arial, Helvetica, sans-serif&quot;</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">&quot;#0B610B&quot;</span>&gt;</span>构建信息<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">hr</span> <span class="attr">size</span>=<span class="string">&quot;2&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100%&quot;</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">td</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>项目名称 ：$&#123;PROJECT_NAME&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>构建状态 ：$&#123;BUILD_STATUS&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>构建编号 ：第$&#123;BUILD_NUMBER&#125;次构建<span class="tag">&lt;/<span class="name">li</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>触发原因 ：$&#123;CAUSE&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>构建日志 ：<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;BUILD_URL&#125;console&quot;</span>&gt;</span>$&#123;BUILD_URL&#125;console<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>构建URL ：<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;BUILD_URL&#125;&quot;</span>&gt;</span>$&#123;BUILD_URL&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>工作目录 ：<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;PROJECT_URL&#125;ws&quot;</span>&gt;</span>$&#123;PROJECT_URL&#125;ws<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>项目URL ：<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;PROJECT_URL&#125;&quot;</span>&gt;</span>$&#123;PROJECT_URL&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">&quot;#0B610B&quot;</span>&gt;</span>变更集<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">hr</span> <span class="attr">size</span>=<span class="string">&quot;2&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100%&quot;</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span>  </span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">td</span>&gt;</span>$&#123;JELLY_SCRIPT,template=&quot;html&quot;&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">hr</span> <span class="attr">size</span>=<span class="string">&quot;2&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100%&quot;</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span>  </span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span>  </span><br></pre></td></tr></table></figure>

<h2 id="Jenkins-项目配置SonarQube"><a href="#Jenkins-项目配置SonarQube" class="headerlink" title="Jenkins 项目配置SonarQube"></a>Jenkins 项目配置SonarQube</h2><p>选择自动化风格项目进行项目构建</p>
<ul>
<li><p>丢弃旧的构建</p>
<ul>
<li>策略：默认</li>
<li>保持构建的天数 ：5</li>
<li>保持构建的最大个数：2</li>
</ul>
</li>
<li><p>源码管理：SVN或Git</p>
</li>
<li><p>构建触发器：SCM（策略H/15 * * * *）或Git Hook</p>
</li>
<li><p>构建环境</p>
<ul>
<li><p><input checked="" disabled="" type="checkbox">  Add timestamps to the Console Output </p>
</li>
<li><p><input checked="" disabled="" type="checkbox">  Prepare SonarQube Scanner environment</p>
</li>
</ul>
</li>
<li><p>构建</p>
<ul>
<li><strong>execute SonarQube Scanner</strong><ul>
<li>Task to run：为空</li>
<li>JDK：默认</li>
<li>Analysis properties ：见下文</li>
</ul>
</li>
</ul>
</li>
<li><p>构建后操作</p>
<ul>
<li><strong>Editable Email Notification</strong><ul>
<li><input disabled="" type="checkbox"> Disable Extended Email Publisher </li>
<li>Project From:为空</li>
<li>Project Recipient List：$DEFAULT_RECIPIENTS</li>
<li>Project Reply-To List：$DEFAULT_REPLYTO</li>
<li>Content Type：默认</li>
<li>Default Subject：$DEFAULT_SUBJECT</li>
<li>Default Content：$DEFAULT_CONTENT</li>
<li>Pre-send Script：$DEFAULT_PRESEND_SCRIPT</li>
<li>Post-send Script：$DEFAULT_POSTSEND_SCRIPT</li>
<li>Triggers<ul>
<li>配置 失败、成功的触发场景</li>
<li>Send To 新增 <strong>Recipient List</strong></li>
<li>添加收件人，多个用,分隔</li>
<li>其他默认</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>成功的邮件内容特别配置</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>$&#123;ENV, var=&quot;JOB_NAME&quot;&#125;-第$&#123;BUILD_NUMBER&#125;次构建日志<span class="tag">&lt;/<span class="name">title</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span>    </span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">leftmargin</span>=<span class="string">&quot;8&quot;</span> <span class="attr">marginwidth</span>=<span class="string">&quot;0&quot;</span> <span class="attr">topmargin</span>=<span class="string">&quot;8&quot;</span> <span class="attr">marginheight</span>=<span class="string">&quot;4&quot;</span>    </span></span><br><span class="line"><span class="tag">    <span class="attr">offset</span>=<span class="string">&quot;0&quot;</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">width</span>=<span class="string">&quot;95%&quot;</span> <span class="attr">cellpadding</span>=<span class="string">&quot;0&quot;</span> <span class="attr">cellspacing</span>=<span class="string">&quot;0&quot;</span>  <span class="attr">style</span>=<span class="string">&quot;font-size: 11pt; font-family: Tahoma, Arial, Helvetica, sans-serif&quot;</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">            本邮件由系统自动发出，无需回复！<span class="tag">&lt;<span class="name">br</span>/&gt;</span>            </span><br><span class="line">            各位同事，大家好，以下为$&#123;PROJECT_NAME &#125;项目构建信息<span class="tag">&lt;/<span class="name">br</span>&gt;</span> </span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">&quot;#CC0000&quot;</span>&gt;</span>构建结果 - $&#123;BUILD_STATUS&#125;<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span>   </span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">&quot;#0B610B&quot;</span>&gt;</span>构建信息<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;<span class="name">hr</span> <span class="attr">size</span>=<span class="string">&quot;2&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100%&quot;</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span>    </span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>    </span><br><span class="line">                <span class="tag">&lt;<span class="name">ul</span>&gt;</span>    </span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>项目名称 ： $&#123;PROJECT_NAME&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span>    </span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>构建编号 ： 第$&#123;BUILD_NUMBER&#125;次构建<span class="tag">&lt;/<span class="name">li</span>&gt;</span>    </span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>触发原因： $&#123;CAUSE&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span>    </span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>构建状态： $&#123;BUILD_STATUS&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span>    </span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>构建日志： <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;BUILD_URL&#125;console&quot;</span>&gt;</span>$&#123;BUILD_URL&#125;console<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span>    </span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>构建  URL ： <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;BUILD_URL&#125;&quot;</span>&gt;</span>$&#123;BUILD_URL&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span>    </span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>工作目录 ： <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;PROJECT_URL&#125;ws&quot;</span>&gt;</span>$&#123;PROJECT_URL&#125;ws<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span>    </span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>项目  URL ： <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;PROJECT_URL&#125;&quot;</span>&gt;</span>$&#123;PROJECT_URL&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span> </span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>代码质量扫描结果  URL： <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;BUILD_LOG_REGEX, regex=&quot;</span><span class="attr">.</span>*<span class="attr">ANALYSIS</span> <span class="attr">SUCCESSFUL</span>, <span class="attr">you</span> <span class="attr">can</span> <span class="attr">browse</span> (<span class="attr">.</span>*)&quot;, <span class="attr">showTruncatedLines</span>=<span class="string">false,</span> <span class="attr">substText</span>=<span class="string">&quot;$1&quot;</span>&#125;   &quot;&gt;</span>$&#123;BUILD_LOG_REGEX, regex=&quot;.*ANALYSIS SUCCESSFUL, you can browse (.*)&quot;, showTruncatedLines=false, substText=&quot;$1&quot;&#125;   <span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span>    </span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">&quot;#0B610B&quot;</span>&gt;</span>失败用例<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span> <span class="attr">size</span>=<span class="string">&quot;2&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100%&quot;</span> /&gt;</span></span><br><span class="line">$FAILED_TESTS<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">h4</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">&quot;#0B610B&quot;</span>&gt;</span>最近提交(#$SVN_REVISION)<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span> <span class="attr">size</span>=<span class="string">&quot;2&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100%&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">$&#123;CHANGES_SINCE_LAST_SUCCESS, reverse=true, format=&quot;%c&quot;, changesFormat=&quot;<span class="tag">&lt;<span class="name">li</span>&gt;</span>%d [%a] %m<span class="tag">&lt;/<span class="name">li</span>&gt;</span>&quot;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">详细提交: <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;$&#123;PROJECT_URL&#125;changes&quot;</span>&gt;</span>$&#123;PROJECT_URL&#125;changes<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line"> </span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/03/28/merge-two-sorted-lists/">merge-two-sorted-lists</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-03-28</time><div class="content"></div><hr></div><nav id="pagination"><div class="pagination"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2021 By acshmily</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>